'use strict';require('dotenv/config'),require('clsx'),require('lodash/camelCase'),require('lodash/startCase'),require('tailwind-merge');var tldts=require('tldts'),adapterPg=require('@prisma/adapter-pg'),K=require('path'),url=require('url'),u=require('@prisma/client/runtime/client'),ce=require('fs');require('countries-and-timezones');var ge=require('lodash/keyBy'),Pe=require('lodash/orderBy'),ye=require('lodash/isUndefined'),z=require('lodash/isEmpty'),be=require('fastq');var _documentCurrentScript=typeof document!=='undefined'?document.currentScript:null;function _interopDefault(e){return e&&e.__esModule?e:{default:e}}function _interopNamespace(e){if(e&&e.__esModule)return e;var n=Object.create(null);if(e){Object.keys(e).forEach(function(k){if(k!=='default'){var d=Object.getOwnPropertyDescriptor(e,k);Object.defineProperty(n,k,d.get?d:{enumerable:true,get:function(){return e[k]}});}})}n.default=e;return Object.freeze(n)}var K__namespace=/*#__PURE__*/_interopNamespace(K);var u__namespace=/*#__PURE__*/_interopNamespace(u);var ce__default=/*#__PURE__*/_interopDefault(ce);var ge__default=/*#__PURE__*/_interopDefault(ge);var Pe__default=/*#__PURE__*/_interopDefault(Pe);var ye__default=/*#__PURE__*/_interopDefault(ye);var z__default=/*#__PURE__*/_interopDefault(z);var be__default=/*#__PURE__*/_interopDefault(be);var T=()=>new Date().toUTCString();var J=new Map;function D(i){let t=J.get(i);if(t)return t;let e=tldts.getDomain(i)||re(i);return J.set(i,e),e}function re(i){let t=i;return /^https?:\/\//.test(t)||(t=`https://${t}`),new URL(t).host.replace("www.","")}var q={previewFeatures:[],clientVersion:"7.0.0",engineVersion:"0c19ccc313cf9911a90d99d2ac2eb0280c76c513",activeProvider:"postgresql",inlineSchema:`generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
}

model Account {
  id                    String    @id @default(uuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([token])
  @@index([userId])
}

model User {
  id            String  @id @default(uuid())
  name          String
  email         String  @unique
  emailVerified Boolean
  image         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions         Session[]
  accounts         Account[]
  lists            List[]
  campaigns        Campaign[]
  extensionPayload ExtensionPayload[]
  queueJobs        QueueJob[]
  linkedinSessions LinkedInSession?

  @@index([email])
}

model List {
  id   String @id @default(uuid())
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  leads Lead[]

  @@index([userId])
  @@index([id, userId])
}

enum LeadSource {
  sales_nav
  linkedin_search
  manual_entry
}

model Lead {
  id                String     @id @default(uuid())
  firstName         String
  lastName          String
  country           String?
  city              String?
  isLinkedinPremium Boolean    @default(false)
  linkedinId        String?
  linkedinHash      String?
  jobTitle          String?
  industry          String?
  source            LeadSource

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  listId   String
  list     List       @relation(fields: [listId], references: [id], onDelete: Cascade)
  campaign Campaign[]

  @@index([firstName, lastName])
  @@index([firstName, lastName, country])
  @@index([firstName, lastName, city])
  @@index([firstName, lastName, isLinkedinPremium])
  @@index([country])
  @@index([city])
  @@index([isLinkedinPremium])
}

model Company {
  id String @id @default(uuid())

  name        String
  domain      String  @unique
  size        String?
  linkedinUrl String?
  industry    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads Lead[]

  @@index([name])
  @@index([domain])
  @@index([name, domain])
  @@index([size])
}

model Campaign {
  id            String  @id @default(uuid())
  name          String
  timezone      String  @default("America/New_York")
  excludeActive Boolean @default(true)
  dailyLimit    Int     @default(25)

  userId String
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  listId String?        @unique
  steps  SequenceStep[]
  leads  Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timezone])
  @@index([excludeActive])
  @@index([dailyLimit])
  @@index([listId, timezone])
}

enum StepType {
  connection
  wait
  message
}

model SequenceStep {
  id      String   @id @default(cuid())
  order   Int // position in the sequence
  type    StepType
  content String? // for connection + message
  days    Int? // for wait steps

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([campaignId])
  @@index([campaignId, type])
  @@index([type, days])
}

model ExtensionPayload {
  id      String @id @default(cuid())
  hash    String @unique
  payload Json?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, hash])
}

enum QueueJobType {
  sales_nav_extraction
}

enum QueueJobStatus {
  todo
  processing
  completed
  cancelled
}

model QueueJob {
  id          String         @id @default(uuid())
  status      QueueJobStatus @default(todo)
  type        QueueJobType
  input       Json
  lastMessage String?
  logs        String[]
  isFailed    Boolean        @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([userId])
}

enum LinkedInSessionStatus {
  active
  inactive
}

model LinkedInSession {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cookies       Json?
  headers       Json[]
  lastCheckedAt DateTime?

  status LinkedInSessionStatus @default(inactive)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
`,runtimeDataModel:{models:{},enums:{},types:{}}};q.runtimeDataModel=JSON.parse('{"models":{"Verification":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"identifier","kind":"scalar","type":"String"},{"name":"value","kind":"scalar","type":"String"},{"name":"expiresAt","kind":"scalar","type":"DateTime"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"Account":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"userId","kind":"scalar","type":"String"},{"name":"accountId","kind":"scalar","type":"String"},{"name":"providerId","kind":"scalar","type":"String"},{"name":"accessToken","kind":"scalar","type":"String"},{"name":"refreshToken","kind":"scalar","type":"String"},{"name":"accessTokenExpiresAt","kind":"scalar","type":"DateTime"},{"name":"refreshTokenExpiresAt","kind":"scalar","type":"DateTime"},{"name":"scope","kind":"scalar","type":"String"},{"name":"idToken","kind":"scalar","type":"String"},{"name":"password","kind":"scalar","type":"String"},{"name":"user","kind":"object","type":"User","relationName":"AccountToUser"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"Session":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"userId","kind":"scalar","type":"String"},{"name":"token","kind":"scalar","type":"String"},{"name":"expiresAt","kind":"scalar","type":"DateTime"},{"name":"ipAddress","kind":"scalar","type":"String"},{"name":"userAgent","kind":"scalar","type":"String"},{"name":"user","kind":"object","type":"User","relationName":"SessionToUser"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"User":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"name","kind":"scalar","type":"String"},{"name":"email","kind":"scalar","type":"String"},{"name":"emailVerified","kind":"scalar","type":"Boolean"},{"name":"image","kind":"scalar","type":"String"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"},{"name":"sessions","kind":"object","type":"Session","relationName":"SessionToUser"},{"name":"accounts","kind":"object","type":"Account","relationName":"AccountToUser"},{"name":"lists","kind":"object","type":"List","relationName":"ListToUser"},{"name":"campaigns","kind":"object","type":"Campaign","relationName":"CampaignToUser"},{"name":"extensionPayload","kind":"object","type":"ExtensionPayload","relationName":"ExtensionPayloadToUser"},{"name":"queueJobs","kind":"object","type":"QueueJob","relationName":"QueueJobToUser"},{"name":"linkedinSessions","kind":"object","type":"LinkedInSession","relationName":"LinkedInSessionToUser"}],"dbName":null},"List":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"name","kind":"scalar","type":"String"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"},{"name":"user","kind":"object","type":"User","relationName":"ListToUser"},{"name":"userId","kind":"scalar","type":"String"},{"name":"leads","kind":"object","type":"Lead","relationName":"LeadToList"}],"dbName":null},"Lead":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"firstName","kind":"scalar","type":"String"},{"name":"lastName","kind":"scalar","type":"String"},{"name":"country","kind":"scalar","type":"String"},{"name":"city","kind":"scalar","type":"String"},{"name":"isLinkedinPremium","kind":"scalar","type":"Boolean"},{"name":"linkedinId","kind":"scalar","type":"String"},{"name":"linkedinHash","kind":"scalar","type":"String"},{"name":"jobTitle","kind":"scalar","type":"String"},{"name":"industry","kind":"scalar","type":"String"},{"name":"source","kind":"enum","type":"LeadSource"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"},{"name":"companyId","kind":"scalar","type":"String"},{"name":"company","kind":"object","type":"Company","relationName":"CompanyToLead"},{"name":"listId","kind":"scalar","type":"String"},{"name":"list","kind":"object","type":"List","relationName":"LeadToList"},{"name":"campaign","kind":"object","type":"Campaign","relationName":"CampaignToLead"}],"dbName":null},"Company":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"name","kind":"scalar","type":"String"},{"name":"domain","kind":"scalar","type":"String"},{"name":"size","kind":"scalar","type":"String"},{"name":"linkedinUrl","kind":"scalar","type":"String"},{"name":"industry","kind":"scalar","type":"String"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"},{"name":"leads","kind":"object","type":"Lead","relationName":"CompanyToLead"}],"dbName":null},"Campaign":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"name","kind":"scalar","type":"String"},{"name":"timezone","kind":"scalar","type":"String"},{"name":"excludeActive","kind":"scalar","type":"Boolean"},{"name":"dailyLimit","kind":"scalar","type":"Int"},{"name":"userId","kind":"scalar","type":"String"},{"name":"user","kind":"object","type":"User","relationName":"CampaignToUser"},{"name":"listId","kind":"scalar","type":"String"},{"name":"steps","kind":"object","type":"SequenceStep","relationName":"CampaignToSequenceStep"},{"name":"leads","kind":"object","type":"Lead","relationName":"CampaignToLead"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"SequenceStep":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"order","kind":"scalar","type":"Int"},{"name":"type","kind":"enum","type":"StepType"},{"name":"content","kind":"scalar","type":"String"},{"name":"days","kind":"scalar","type":"Int"},{"name":"campaignId","kind":"scalar","type":"String"},{"name":"campaign","kind":"object","type":"Campaign","relationName":"CampaignToSequenceStep"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"ExtensionPayload":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"hash","kind":"scalar","type":"String"},{"name":"payload","kind":"scalar","type":"Json"},{"name":"userId","kind":"scalar","type":"String"},{"name":"user","kind":"object","type":"User","relationName":"ExtensionPayloadToUser"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"QueueJob":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"status","kind":"enum","type":"QueueJobStatus"},{"name":"type","kind":"enum","type":"QueueJobType"},{"name":"input","kind":"scalar","type":"Json"},{"name":"lastMessage","kind":"scalar","type":"String"},{"name":"logs","kind":"scalar","type":"String"},{"name":"isFailed","kind":"scalar","type":"Boolean"},{"name":"userId","kind":"scalar","type":"String"},{"name":"user","kind":"object","type":"User","relationName":"QueueJobToUser"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null},"LinkedInSession":{"fields":[{"name":"id","kind":"scalar","type":"String"},{"name":"userId","kind":"scalar","type":"String"},{"name":"user","kind":"object","type":"User","relationName":"LinkedInSessionToUser"},{"name":"cookies","kind":"scalar","type":"Json"},{"name":"headers","kind":"scalar","type":"Json"},{"name":"lastCheckedAt","kind":"scalar","type":"DateTime"},{"name":"status","kind":"enum","type":"LinkedInSessionStatus"},{"name":"createdAt","kind":"scalar","type":"DateTime"},{"name":"updatedAt","kind":"scalar","type":"DateTime"}],"dbName":null}},"enums":{},"types":{}}');async function ae(i){let{Buffer:t}=await import('buffer'),e=t.from(i,"base64");return new WebAssembly.Module(e)}q.compilerWasm={getRuntime:async()=>await import('@prisma/client/runtime/query_compiler_bg.postgresql.mjs'),getQueryCompilerWasmModule:async()=>{let{wasm:i}=await import('@prisma/client/runtime/query_compiler_bg.postgresql.wasm-base64.mjs');return await ae(i)}};function V(){return u__namespace.getPrismaClient(q)}u__namespace.Extensions.getExtensionContext;({DbNull:u__namespace.NullTypes.DbNull,JsonNull:u__namespace.NullTypes.JsonNull,AnyNull:u__namespace.NullTypes.AnyNull});u__namespace.makeStrictEnum({ReadUncommitted:"ReadUncommitted",ReadCommitted:"ReadCommitted",RepeatableRead:"RepeatableRead",Serializable:"Serializable"});u__namespace.Extensions.defineExtension;globalThis.__dirname=K__namespace.dirname(url.fileURLToPath((typeof document === 'undefined' ? require('u' + 'rl').pathToFileURL(__filename).href : (_documentCurrentScript && _documentCurrentScript.tagName.toUpperCase() === 'SCRIPT' && _documentCurrentScript.src || new URL('index.js', document.baseURI).href))));var H=V();var me=new adapterPg.PrismaPg({connectionString:process.env.DATABASE_URL}),ue=new H({adapter:me,errorFormat:"pretty",transactionOptions:{maxWait:600*1e3,timeout:600*1e3}}),Q=globalThis,p=Q.db||ue;process.env.NODE_ENV!=="production"&&(Q.db=p);var y=class{constructor(t){this.params=t;this._scraperMandatoryDelayBtwnRequestsMaxMs=650;this._scraperMandatoryDelayBtwnRequestsMinMs=350;this._buildLinkedinHeaders=t=>{t.JSESSIONID||console.warn("missing linkedin cookie JSESSIONID"),t.li_at||console.warn("missing linkedin cookie li_at"),t.li_a||console.log("linkedin cookie li_a is not set, this is a normal use case if user is not a Sales Nav user");let e=`li_at=${t.li_at}; JSESSIONID=${t.JSESSIONID};`;t.li_a&&(e+=` li_a=${t.li_a}; `);let n=(t.li_at||this._randChar(82)).replace(/_|-/g,"");e+=' bcookie="v=2&'+`${n.substring(0,8)}-${n.substring(0,4)}-${n.substring(0,4)}-${n.substring(0,4)}-${n.substring(0,12)}`.toLocaleLowerCase()+'";',e+=' bscookie="";',e+=` li_alerts=${this._randChar(3)}=;`,e+=` AMCVS_${this._randChar(24).toLocaleUpperCase()}%40AdobeOrg=1;`,e+=` AMCV_${this._randChar(24).toLocaleUpperCase()}%40AdobeOrg=-${this._randNum(9)}%7C${this._randChar(6)}%7C${this._randChar(5)}%7C${this._randChar(5)}%7C${this._randChar(38)}%7C${this._randChar(7)}-${this._randNum(10)}%7C${this._randNum(1)}%7C${this._randChar(6)}-${this._randNum(10)}%7C${this._randChar(52)}%7C${this._randChar(8)}-${this._randNum(10)}s%7CNONE%7CvVersion%7C5.1.1%7C${this._randChar(6)}%7C-${this._randNum(9)}; UserMatchHistory=${this._randChar(295)};`,e+=` _gcl_au=1.1.${this._randNum(10)}.${this._randNum(10)};`,e+=` aam_uuid=${this._randNum(38)};`,e+=` li_sugr=${this._randChar(8)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(12)};`,e+=` SID=${this._randChar(8)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(12)};`,e+=` VID=V_2022_09_22_09_${this._randNum(7)};`;let r=`GCL.${this._randNum(10)}.${this._randChar(47)}-${this._randChar(43)}`;e+=` _gcl_aw=${r};`,e+=` _gcl_dc=${r};`,e+=` __ssid=${this._randChar(8)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(12)};`,e+=` dfpfpt=${this._randChar(32).toLocaleLowerCase()};`,e+=` fptctx2=${this._randChar(50)}%25${this._randChar(13)}%25${this._randChar(27)}%25${this._randChar(38)}%25${this._randChar(64)}%25${this._randChar(128)}%25${this._randChar(4)}%25${this._randChar(21)}%25${this._randChar(2)};`,e+=" liveagent_oref=https://www.linkedin.com/sales/on-boarding/welcome;",e+=` liveagent_ptid=${this._randChar(8)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(12)};`,e+=` liveagent_sid=${this._randChar(8)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(12)};`,e+=` liveagent_vc=${this._randChar(3)};`,e+=` _guid=${this._randChar(8)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(4)}-${this._randChar(12)};`,e+=` li_gc=${this._randChar(71)}=;`,e+=` sdsc=1%3A${this._randChar(28)}%3D;`,e+=` mbox=PC#${this._randChar(32).toLocaleLowerCase()}.37_0#${this._randNum(10)}|session#${this._randChar(32).toLocaleLowerCase()}#${this._randNum(10)};`,e+=` s_fid=${this._randChar(16)}-${this._randChar(16)};`,e+=` PLAY_SESSION=${this._randChar(20)}.${this._randChar(307)}-${this._randChar(194)}.${this._randChar(41)}-4;`,e+=` g_state={"i_l":1,"i_p":1673970${this._randNum(6)}};`,e+=` AnalyticsSyncHistory=${this._randChar(24)}-${this._randChar(39)}_${this._randChar(21)};`;let a=`${this._randChar(22)}-${this._randChar(16)}-${this._randChar(48)}-${this._randChar(7)}`;return e+=` lms_ads=${a};`,e+=` lms_analytics=${a};`,e+=` li_mc=${this._randChar(29)}/${this._randChar(5)}+g/${this._randChar(24)}/${this._randChar(8)}=;`,e+=` lidc="b=${this._randChar(4)}:s=T:r=T:a=T:p=T:g=${this._randNum(4)}:u=${this._randNum(3)}:x=1:i=${this._randNum(10)}:t=${this._randNum(10)}:v=2:sig=${this._randChar(32)}";`,e+=" G_ENABLED_IDPS=google; li_theme=light; li_theme_set=app; timezone=Europe/Paris;",e+=" s_cc=true; PLAY_LANG=en; at_check=true; s_sq=%5B%5BB%5D%5D;",e+=" gpv_pn=developer.linkedin.com%2F; s_plt=2.55; s_pltp=developer.linkedin.com%2F; s_ips=1316; s_tp=2536;",e+=" s_ppv=developer.linkedin.com%2F%2C52%2C52%2C1316%2C1%2C2; s_tslv=1673874952444;",e+=" visit=v=1&M; liap=true; lang=v=2&lang=en-US;",{cookie:e,"csrf-token":t.JSESSIONID?.replace(/"/g,"")||"","accept-language":"en-US,en;q=0.9,fr-FR;q=0.8,fr;q=0.7","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36","x-restli-protocol-version":"2.0.0",authority:"www.linkedin.com",accept:"application/vnd.linkedin.normalized+json+2.1",referer:"https://www.linkedin.com/feed/","sec-ch-ua":'"Not_A Brand";v="99", "Google Chrome";v="109", "Chromium";v="109"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","x-li-lang":"en_US","x-li-page-instance":`urn:li:page:feed_index_index;${this._randChar(22)}==`,"x-li-track":'{"clientVersion":"1.11.8003","mpVersion":"1.11.8003","osName":"web","timezoneOffset":1,"timezone":"Europe/Paris","deviceFormFactor":"DESKTOP","mpName":"voyager-web","displayDensity":1,"displayWidth":1920,"displayHeight":1080}'}};}async fetchJson(t,e){let n=this._buildLinkedinHeaders(this.params.cookies),r=new Headers(n);this.params.linkedinHeaders&&this.params.linkedinHeaders.forEach(m=>{r.set(m.name,m.value);});let a=this._cleanOutLinkedinHeaders(r),s=this.buildUrl(t,e?.queryParams);console.log(`[Linkedin API::Request] url => ${s}`),await this.sleepRandomDelayBetweenRequests(),e?.overwriteHeaders&&e.overwriteHeaders(a);let l=await fetch(s,{headers:a,...e}),o={};try{o=await l.json(),ce__default.default.writeFileSync("test.json",JSON.stringify(o,null,2));}catch{}if(!l.ok)throw new Error(`Request failed with status ${l.status} ${JSON.stringify(o)}`);return o}_cleanOutLinkedinHeaders(t){let e=new Headers(t);return e.delete("content-encoding"),e.set("accept","*/*"),e}_randChar(t){let e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");return [...Array(t)].map(()=>e[Math.floor(Math.random()*e.length)]).join("")}_randNum(t){let e=[0,1,2,3,4,5,6,7,8,9];return [...Array(t)].map(()=>e[Math.floor(Math.random()*e.length)]).join("")}async sleepRandomDelayBetweenRequests(){let t=Math.floor(Math.random()*(this._scraperMandatoryDelayBtwnRequestsMaxMs-this._scraperMandatoryDelayBtwnRequestsMinMs+1)+this._scraperMandatoryDelayBtwnRequestsMinMs);await this.sleep(t);}sleep(t){return new Promise(e=>setTimeout(e,t))}buildUrl(t,e){let n=new URL(t,this.params.baseURL);return e&&Object.entries(e).forEach(([r,a])=>{n.searchParams.set(r,decodeURIComponent(a));}),n.toString()}};var E=class{constructor({client:t}){this.client=t;}async getOwnProfile(){let t=await this.client.request.profile.getOwnProfile();return t||null}};var g=2500,x=100,U=class extends y{constructor(e){super(e);this.params=e;this.getSalesNavSearch=async(e,n)=>{let r=n?.start||0,a=n?.limit||x;if((a<0||a>x)&&(a=x),r>=g)return {elements:[],paging:{total:0,count:0},metadata:{}};r+a>g&&(a=g-r,console.warn(`Adjusted limit to ${a} because start=${r} would exceed max=${g}`));let s=new URLSearchParams(e);s.delete("decorationId"),s.delete("start"),s.delete("count"),s.set("start",r.toString()),s.set("count",a.toString()),s.set("decoration",this._craftSearchUrlDecoration());let l=s.toString();await this.sleepRandomDelayBetweenRequests();let o;try{o=await this.fetchJson(decodeURIComponent(l));}catch(m){throw console.error("_scrapeOneSearchResultPage error, cannot parse json content, see http response above",m),m}if(o.status===void 0&&!o.elements){if(o?.status===400&&r>=g)return {elements:[],paging:{total:0,count:0},metadata:{}};console.warn("json.elements is undefined","and here the full json",o),console.log("let's try again in few secs"),await this.sleep(3e4),console.log("_scrapeOneSearchResultPage for the second time",l),o=await this.fetchJson(l),o?.status!==400&&!o.elements&&(console.warn("json.elements is still undefined after the second call and should not have been, here the http status code"),console.log("let's the app raise a failed extract"));}if(o.status===400)return {elements:[],paging:{total:0,count:0},metadata:{}};{let m=Math.min(2500,o?.paging?.total||0);return o.paging.total=m,o.paging.count=o.elements.length,o}};}overwriteHeaders(e){delete e["content-encoding"],e.set("accept","*/*");}_getSearchPageUrlParams(e){let n=new URL(e),r=new URLSearchParams(n.search),a=/^\/sales\/lists\/people\//i.test(n.pathname),s=r.get("query"),l=r.get("recentSearchId"),o=r.get("savedSearchId"),m=r.get("lastViewedAt"),c=n.pathname.split("/").pop();return {isSearchingInSavedPeopleList:a,query:s,recentSearchId:l,savedSearchId:o,leadListId:c,lastViewedAt:m}}_craftSearchUrlDecoration(e=false){return encodeURIComponent(e?"(entityUrn)":`(firstName,lastName,entityUrn~fs_salesProfile${this._craftProfileUrlDecoration(true)})`).replace(/\(/g,"%28").replace(/\)/g,"%29")}_craftProfileUrlDecoration(e=false){let n="(entityUrn,firstName,lastName,objectUrn,memberBadges,location,positions*(current,title,companyName,companyUrn~fs_salesCompany(industry,flagshipCompanyUrl,website,employeeCountRange)))";return e!==true&&(n=encodeURIComponent(n).replace(/\(/g,"%28").replace(/\)/g,"%29")),n}};var j=[{code:"AF",code3:"AFG",name:"Afghanistan",number:"004"},{code:"AL",code3:"ALB",name:"Albania",number:"008"},{code:"DZ",code3:"DZA",name:"Algeria",number:"012"},{code:"AS",code3:"ASM",name:"American Samoa",number:"016"},{code:"AD",code3:"AND",name:"Andorra",number:"020"},{code:"AO",code3:"AGO",name:"Angola",number:"024"},{code:"AI",code3:"AIA",name:"Anguilla",number:"660"},{code:"AQ",code3:"ATA",name:"Antarctica",number:"010"},{code:"AG",code3:"ATG",name:"Antigua and Barbuda",number:"028"},{code:"AR",code3:"ARG",name:"Argentina",number:"032"},{code:"AM",code3:"ARM",name:"Armenia",number:"051"},{code:"AW",code3:"ABW",name:"Aruba",number:"533"},{code:"AU",code3:"AUS",name:"Australia",number:"036"},{code:"AT",code3:"AUT",name:"Austria",number:"040"},{code:"AZ",code3:"AZE",name:"Azerbaijan",number:"031"},{code:"BS",code3:"BHS",name:"Bahamas",number:"044"},{code:"BH",code3:"BHR",name:"Bahrain",number:"048"},{code:"BD",code3:"BGD",name:"Bangladesh",number:"050"},{code:"BB",code3:"BRB",name:"Barbados",number:"052"},{code:"BY",code3:"BLR",name:"Belarus",number:"112"},{code:"BE",code3:"BEL",name:"Belgium",number:"056"},{code:"BZ",code3:"BLZ",name:"Belize",number:"084"},{code:"BJ",code3:"BEN",name:"Benin",number:"204"},{code:"BM",code3:"BMU",name:"Bermuda",number:"060"},{code:"BT",code3:"BTN",name:"Bhutan",number:"064"},{code:"BO",code3:"BOL",name:"Bolivia",number:"068"},{code:"BQ",code3:"BES",name:"Bonaire",number:"535"},{code:"BA",code3:"BIH",name:"Bosnia and Herzegovina",number:"070"},{code:"BW",code3:"BWA",name:"Botswana",number:"072"},{code:"BV",code3:"BVT",name:"Bouvet Island",number:"074"},{code:"BR",code3:"BRA",name:"Brazil",number:"076"},{code:"IO",code3:"IOT",name:"British Indian Ocean Territory",number:"086"},{code:"BN",code3:"BRN",name:"Brunei Darussalam",number:"096"},{code:"BG",code3:"BGR",name:"Bulgaria",number:"100"},{code:"BF",code3:"BFA",name:"Burkina Faso",number:"854"},{code:"BI",code3:"BDI",name:"Burundi",number:"108"},{code:"CV",code3:"CPV",name:"Cabo Verde",number:"132"},{code:"KH",code3:"KHM",name:"Cambodia",number:"116"},{code:"CM",code3:"CMR",name:"Cameroon",number:"120"},{code:"CA",code3:"CAN",name:"Canada",number:"124"},{code:"KY",code3:"CYM",name:"Cayman Islands",number:"136"},{code:"CF",code3:"CAF",name:"Central African Republic",number:"140"},{code:"TD",code3:"TCD",name:"Chad",number:"148"},{code:"CL",code3:"CHL",name:"Chile",number:"152"},{code:"CN",code3:"CHN",name:"China",number:"156"},{code:"CX",code3:"CXR",name:"Christmas Island",number:"162"},{code:"CC",code3:"CCK",name:"Cocos (Keeling) Islands",number:"166"},{code:"CO",code3:"COL",name:"Colombia",number:"170"},{code:"KM",code3:"COM",name:"Comoros",number:"174"},{code:"CD",code3:"COD",name:"Congo (the Democratic Republic of the)",number:"180"},{code:"CG",code3:"COG",name:"Congo",number:"178"},{code:"CK",code3:"COK",name:"Cook Islands",number:"184"},{code:"CR",code3:"CRI",name:"Costa Rica",number:"188"},{code:"HR",code3:"HRV",name:"Croatia",number:"191"},{code:"CU",code3:"CUB",name:"Cuba",number:"192"},{code:"CW",code3:"CUW",name:"Cura\xE7ao",number:"531"},{code:"CY",code3:"CYP",name:"Cyprus",number:"196"},{code:"CZ",code3:"CZE",name:"Czechia",number:"203"},{code:"CI",code3:"CIV",name:"C\xF4te d'Ivoire",number:"384"},{code:"DK",code3:"DNK",name:"Denmark",number:"208"},{code:"DJ",code3:"DJI",name:"Djibouti",number:"262"},{code:"DM",code3:"DMA",name:"Dominica",number:"212"},{code:"DO",code3:"DOM",name:"Dominican Republic",number:"214"},{code:"EC",code3:"ECU",name:"Ecuador",number:"218"},{code:"EG",code3:"EGY",name:"Egypt",number:"818"},{code:"SV",code3:"SLV",name:"El Salvador",number:"222"},{code:"GQ",code3:"GNQ",name:"Equatorial Guinea",number:"226"},{code:"ER",code3:"ERI",name:"Eritrea",number:"232"},{code:"EE",code3:"EST",name:"Estonia",number:"233"},{code:"SZ",code3:"SWZ",name:"Eswatini",number:"748"},{code:"ET",code3:"ETH",name:"Ethiopia",number:"231"},{code:"FK",code3:"FLK",name:"Falkland Islands",number:"238"},{code:"FO",code3:"FRO",name:"Faroe Islands",number:"234"},{code:"FJ",code3:"FJI",name:"Fiji",number:"242"},{code:"FI",code3:"FIN",name:"Finland",number:"246"},{code:"FR",code3:"FRA",name:"France",number:"250"},{code:"GF",code3:"GUF",name:"French Guiana",number:"254"},{code:"PF",code3:"PYF",name:"French Polynesia",number:"258"},{code:"TF",code3:"ATF",name:"French Southern Territories",number:"260"},{code:"GA",code3:"GAB",name:"Gabon",number:"266"},{code:"GM",code3:"GMB",name:"Gambia",number:"270"},{code:"GE",code3:"GEO",name:"Georgia",number:"268"},{code:"DE",code3:"DEU",name:"Germany",number:"276"},{code:"GH",code3:"GHA",name:"Ghana",number:"288"},{code:"GI",code3:"GIB",name:"Gibraltar",number:"292"},{code:"GR",code3:"GRC",name:"Greece",number:"300"},{code:"GL",code3:"GRL",name:"Greenland",number:"304"},{code:"GD",code3:"GRD",name:"Grenada",number:"308"},{code:"GP",code3:"GLP",name:"Guadeloupe",number:"312"},{code:"GU",code3:"GUM",name:"Guam",number:"316"},{code:"GT",code3:"GTM",name:"Guatemala",number:"320"},{code:"GG",code3:"GGY",name:"Guernsey",number:"831"},{code:"GN",code3:"GIN",name:"Guinea",number:"324"},{code:"GW",code3:"GNB",name:"Guinea-Bissau",number:"624"},{code:"GY",code3:"GUY",name:"Guyana",number:"328"},{code:"HT",code3:"HTI",name:"Haiti",number:"332"},{code:"HM",code3:"HMD",name:"Heard Island and McDonald Islands",number:"334"},{code:"VA",code3:"VAT",name:"Holy See",number:"336"},{code:"HN",code3:"HND",name:"Honduras",number:"340"},{code:"HK",code3:"HKG",name:"Hong Kong",number:"344"},{code:"HU",code3:"HUN",name:"Hungary",number:"348"},{code:"IS",code3:"ISL",name:"Iceland",number:"352"},{code:"IN",code3:"IND",name:"India",number:"356"},{code:"ID",code3:"IDN",name:"Indonesia",number:"360"},{code:"IR",code3:"IRN",name:"Iran",number:"364"},{code:"IQ",code3:"IRQ",name:"Iraq",number:"368"},{code:"IE",code3:"IRL",name:"Ireland",number:"372"},{code:"IM",code3:"IMN",name:"Isle of Man",number:"833"},{code:"IL",code3:"ISR",name:"Israel",number:"376"},{code:"IT",code3:"ITA",name:"Italy",number:"380"},{code:"JM",code3:"JAM",name:"Jamaica",number:"388"},{code:"JP",code3:"JPN",name:"Japan",number:"392"},{code:"JE",code3:"JEY",name:"Jersey",number:"832"},{code:"JO",code3:"JOR",name:"Jordan",number:"400"},{code:"KZ",code3:"KAZ",name:"Kazakhstan",number:"398"},{code:"KE",code3:"KEN",name:"Kenya",number:"404"},{code:"KI",code3:"KIR",name:"Kiribati",number:"296"},{code:"KP",code3:"PRK",name:"Korea",number:"408"},{code:"KR",code3:"KOR",name:"Korea",number:"410"},{code:"KW",code3:"KWT",name:"Kuwait",number:"414"},{code:"KG",code3:"KGZ",name:"Kyrgyzstan",number:"417"},{code:"LA",code3:"LAO",name:"Lao People's Democratic Republic",number:"418"},{code:"LV",code3:"LVA",name:"Latvia",number:"428"},{code:"LB",code3:"LBN",name:"Lebanon",number:"422"},{code:"LS",code3:"LSO",name:"Lesotho",number:"426"},{code:"LR",code3:"LBR",name:"Liberia",number:"430"},{code:"LY",code3:"LBY",name:"Libya",number:"434"},{code:"LI",code3:"LIE",name:"Liechtenstein",number:"438"},{code:"LT",code3:"LTU",name:"Lithuania",number:"440"},{code:"LU",code3:"LUX",name:"Luxembourg",number:"442"},{code:"MO",code3:"MAC",name:"Macao",number:"446"},{code:"MG",code3:"MDG",name:"Madagascar",number:"450"},{code:"MW",code3:"MWI",name:"Malawi",number:"454"},{code:"MY",code3:"MYS",name:"Malaysia",number:"458"},{code:"MV",code3:"MDV",name:"Maldives",number:"462"},{code:"ML",code3:"MLI",name:"Mali",number:"466"},{code:"MT",code3:"MLT",name:"Malta",number:"470"},{code:"MH",code3:"MHL",name:"Marshall Islands",number:"584"},{code:"MQ",code3:"MTQ",name:"Martinique",number:"474"},{code:"MR",code3:"MRT",name:"Mauritania",number:"478"},{code:"MU",code3:"MUS",name:"Mauritius",number:"480"},{code:"YT",code3:"MYT",name:"Mayotte",number:"175"},{code:"MX",code3:"MEX",name:"Mexico",number:"484"},{code:"FM",code3:"FSM",name:"Micronesia",number:"583"},{code:"MD",code3:"MDA",name:"Moldova",number:"498"},{code:"MC",code3:"MCO",name:"Monaco",number:"492"},{code:"MN",code3:"MNG",name:"Mongolia",number:"496"},{code:"ME",code3:"MNE",name:"Montenegro",number:"499"},{code:"MS",code3:"MSR",name:"Montserrat",number:"500"},{code:"MA",code3:"MAR",name:"Morocco",number:"504"},{code:"MZ",code3:"MOZ",name:"Mozambique",number:"508"},{code:"MM",code3:"MMR",name:"Myanmar",number:"104"},{code:"NA",code3:"NAM",name:"Namibia",number:"516"},{code:"NR",code3:"NRU",name:"Nauru",number:"520"},{code:"NP",code3:"NPL",name:"Nepal",number:"524"},{code:"NL",code3:"NLD",name:"Netherlands",number:"528"},{code:"NC",code3:"NCL",name:"New Caledonia",number:"540"},{code:"NZ",code3:"NZL",name:"New Zealand",number:"554"},{code:"NI",code3:"NIC",name:"Nicaragua",number:"558"},{code:"NE",code3:"NER",name:"Niger",number:"562"},{code:"NG",code3:"NGA",name:"Nigeria",number:"566"},{code:"NU",code3:"NIU",name:"Niue",number:"570"},{code:"NF",code3:"NFK",name:"Norfolk Island",number:"574"},{code:"MP",code3:"MNP",name:"Northern Mariana Islands",number:"580"},{code:"NO",code3:"NOR",name:"Norway",number:"578"},{code:"OM",code3:"OMN",name:"Oman",number:"512"},{code:"PK",code3:"PAK",name:"Pakistan",number:"586"},{code:"PW",code3:"PLW",name:"Palau",number:"585"},{code:"PS",code3:"PSE",name:"Palestine, State of",number:"275"},{code:"PA",code3:"PAN",name:"Panama",number:"591"},{code:"PG",code3:"PNG",name:"Papua New Guinea",number:"598"},{code:"PY",code3:"PRY",name:"Paraguay",number:"600"},{code:"PE",code3:"PER",name:"Peru",number:"604"},{code:"PH",code3:"PHL",name:"Philippines",number:"608"},{code:"PN",code3:"PCN",name:"Pitcairn",number:"612"},{code:"PL",code3:"POL",name:"Poland",number:"616"},{code:"PT",code3:"PRT",name:"Portugal",number:"620"},{code:"PR",code3:"PRI",name:"Puerto Rico",number:"630"},{code:"QA",code3:"QAT",name:"Qatar",number:"634"},{code:"MK",code3:"MKD",name:"Republic of North Macedonia",number:"807"},{code:"RO",code3:"ROU",name:"Romania",number:"642"},{code:"RU",code3:"RUS",name:"Russian Federation",number:"643"},{code:"RW",code3:"RWA",name:"Rwanda",number:"646"},{code:"RE",code3:"REU",name:"R\xE9union",number:"638"},{code:"BL",code3:"BLM",name:"Saint Barth\xE9lemy",number:"652"},{code:"SH",code3:"SHN",name:"Saint Helena",number:"654"},{code:"KN",code3:"KNA",name:"Saint Kitts and Nevis",number:"659"},{code:"LC",code3:"LCA",name:"Saint Lucia",number:"662"},{code:"MF",code3:"MAF",name:"Saint Martin",number:"663"},{code:"PM",code3:"SPM",name:"Saint Pierre and Miquelon",number:"666"},{code:"VC",code3:"VCT",name:"Saint Vincent and the Grenadines",number:"670"},{code:"WS",code3:"WSM",name:"Samoa",number:"882"},{code:"SM",code3:"SMR",name:"San Marino",number:"674"},{code:"ST",code3:"STP",name:"Sao Tome and Principe",number:"678"},{code:"SA",code3:"SAU",name:"Saudi Arabia",number:"682"},{code:"SN",code3:"SEN",name:"Senegal",number:"686"},{code:"RS",code3:"SRB",name:"Serbia",number:"688"},{code:"SC",code3:"SYC",name:"Seychelles",number:"690"},{code:"SL",code3:"SLE",name:"Sierra Leone",number:"694"},{code:"SG",code3:"SGP",name:"Singapore",number:"702"},{code:"SX",code3:"SXM",name:"Sint Maarten",number:"534"},{code:"SK",code3:"SVK",name:"Slovakia",number:"703"},{code:"SI",code3:"SVN",name:"Slovenia",number:"705"},{code:"SB",code3:"SLB",name:"Solomon Islands",number:"090"},{code:"SO",code3:"SOM",name:"Somalia",number:"706"},{code:"ZA",code3:"ZAF",name:"South Africa",number:"710"},{code:"GS",code3:"SGS",name:"South Georgia and the South Sandwich Islands",number:"239"},{code:"SS",code3:"SSD",name:"South Sudan",number:"728"},{code:"ES",code3:"ESP",name:"Spain",number:"724"},{code:"LK",code3:"LKA",name:"Sri Lanka",number:"144"},{code:"SD",code3:"SDN",name:"Sudan",number:"729"},{code:"SR",code3:"SUR",name:"Suriname",number:"740"},{code:"SJ",code3:"SJM",name:"Svalbard and Jan Mayen",number:"744"},{code:"SE",code3:"SWE",name:"Sweden",number:"752"},{code:"CH",code3:"CHE",name:"Switzerland",number:"756"},{code:"SY",code3:"SYR",name:"Syrian Arab Republic",number:"760"},{code:"TW",code3:"TWN",name:"Taiwan",number:"158"},{code:"TJ",code3:"TJK",name:"Tajikistan",number:"762"},{code:"TZ",code3:"TZA",name:"Tanzania, United Republic of",number:"834"},{code:"TH",code3:"THA",name:"Thailand",number:"764"},{code:"TL",code3:"TLS",name:"Timor-Leste",number:"626"},{code:"TG",code3:"TGO",name:"Togo",number:"768"},{code:"TK",code3:"TKL",name:"Tokelau",number:"772"},{code:"TO",code3:"TON",name:"Tonga",number:"776"},{code:"TT",code3:"TTO",name:"Trinidad and Tobago",number:"780"},{code:"TN",code3:"TUN",name:"Tunisia",number:"788"},{code:"TR",code3:"TUR",name:"Turkey",number:"792"},{code:"TM",code3:"TKM",name:"Turkmenistan",number:"795"},{code:"TC",code3:"TCA",name:"Turks and Caicos Islands",number:"796"},{code:"TV",code3:"TUV",name:"Tuvalu",number:"798"},{code:"UG",code3:"UGA",name:"Uganda",number:"800"},{code:"UA",code3:"UKR",name:"Ukraine",number:"804"},{code:"AE",code3:"ARE",name:"United Arab Emirates",number:"784"},{code:"GB",code3:"GBR",name:"United Kingdom",number:"826"},{code:"UM",code3:"UMI",name:"United States Minor Outlying Islands",number:"581"},{code:"US",code3:"USA",name:"United States of America",nameShort:"USA",number:"840"},{code:"UY",code3:"URY",name:"Uruguay",number:"858"},{code:"UZ",code3:"UZB",name:"Uzbekistan",number:"860"},{code:"VU",code3:"VUT",name:"Vanuatu",number:"548"},{code:"VE",code3:"VEN",name:"Venezuela",number:"862"},{code:"VN",code3:"VNM",name:"Viet Nam",number:"704"},{code:"VG",code3:"VGB",name:"Virgin Islands (British)",number:"092"},{code:"VI",code3:"VIR",name:"Virgin Islands (U.S.)",number:"850"},{code:"WF",code3:"WLF",name:"Wallis and Futuna",number:"876"},{code:"EH",code3:"ESH",name:"Western Sahara",number:"732"},{code:"YE",code3:"YEM",name:"Yemen",number:"887"},{code:"ZM",code3:"ZMB",name:"Zambia",number:"894"},{code:"ZW",code3:"ZWE",name:"Zimbabwe",number:"716"},{code:"AX",code3:"ALA",name:"\xC5land Islands",number:"248"}];var k=i=>i.trim().toLocaleLowerCase().replace(/-/g," ").replace(/'/g," ").replace(/,/g," ").replace(/ \(.*\)/g,"").replace(/ \[.*\]/g,""),f=i=>{let t,e=i;/^United States$/i.test(e)&&(e="United States of America");for(let n of j){if(new RegExp(k(e)).test(k(n.name))){t=n.code;break}if(new RegExp(k(n.name)).test(k(e))){t=n.code;break}}return t?.toLocaleUpperCase()};var I=class{constructor({client:t}){this._cleanCityFromLinkedinDetails=t=>{let e=t,n=/ ((Metropolitan Area)|(Metropolitan Region)|(Metroplex)|(Bay Area)|(Area)|(Metro)|(Region))$/;return /^([\w ]+-){2}/i.test(e)&&n.test(e)&&(e=e.replace(/^([\w ]+-){2}/i,"")),/^[\w ]+?-/i.test(e)&&n.test(e)&&(e=e.replace(/^[\w ]+?-/i,"")),/--/i.test(e)&&n.test(e)&&(e=e.split("--").pop()||e),e=e.replace(/Greater /i,""),e=e.replace(n,""),e=e.replace(/st\. /gi,"Saint ").replace(/ st\./gi," Saint"),e};this.client=t;}async fetchMetas(t){return this.client.request.salesnavSearch.getSalesNavSearch(t,{start:0,limit:1})}async scrapeSearchResult(t,e,n){let r=0,a=n?.offset||0,s=0,l=Math.floor(n?.offset||0/x);if(a>=g)return console.warn(`Offset ${a} is >= max allowed ${g}. Stopping scraper.`),false;if(n?.leadsLimit&&a+n.leadsLimit>g){let d=g-a;console.warn(`Requested leadsLimit ${n.leadsLimit} with offset ${a} goes past ${g}. Trimming to ${d}.`),n.leadsLimit=d;}let o=this.client.request.salesnavSearch.getSalesNavSearch,m=await o(t,{start:0,limit:1}),c=m.status===void 0?m.paging:{total:0};if(!await e({scrapedLeads:[],progress:0,total:c.total}))return  false;let h=0;do{let d=await o(t,{start:a,limit:n?.leadsLimit&&a+x>n?.leadsLimit?n?.leadsLimit-a:void 0});d.status===400?(console.log(`no leads found for the page ${l}, sounds like there is no more content, lets stop this search here`),s=1):d.paging.count===0?(console.log(`no leads found for the page ${l}, sounds like there is no more content, lets stop this search here`),s=1):(a+=d.paging.count,r+=d.paging.count,n?.leadsLimit&&r>=n.leadsLimit?(console.log("scrapeSearchResult limit of",n.leadsLimit,"leads reached so we can stop the scraper. (we've scrapped",r,"leads)"),s=1):s=r/d.paging.total);let P=await this._formatSalesNavResponse(d);if(!await e({progress:r,scrapedLeads:P,scrapedPage:l,total:d.status===void 0?d.paging.total:0}))return  false;if(l++,h++,h>2500){console.log("forceExitCpt",h);break}}while(s<1);return  true}async _formatSalesNavResponse(t){if(t.status===400)return [];let e=t?.elements||[],n=[];for(let r of e){let a=r.entityUrn.split(",")[0].replace("urn:li:fs_salesProfile:(",""),{country:s,city:l}=await this.parseLocation(r.entityUrnResolutionResult.location),o=(r.entityUrnResolutionResult.positions||[]).filter(m=>m.current).map(m=>({jobTitle:m.title,companyName:m.companyName,companyWebsite:m.companyUrnResolutionResult?.website,companyLinkedinUrl:m.companyUrnResolutionResult?.flagshipCompanyUrl,companySize:m.companyUrnResolutionResult?.employeeCountRange==="myself only"?"1":m.companyUrnResolutionResult?.employeeCountRange,industry:m.companyUrnResolutionResult?.industry}));n.push({lead:{firstName:r.entityUrnResolutionResult.firstName||r.firstName,lastName:r.entityUrnResolutionResult.lastName||r.lastName,linkedinId:r.entityUrnResolutionResult.objectUrn.split(":").pop(),profileHash:a,country:s,city:l,isLinkedinPremium:r.entityUrnResolutionResult.memberBadges?.premium,companyName:o[0]?.companyName,companyWebsite:o[0]?.companyWebsite,companySize:o[0]?.companySize,jobTitle:o[0]?.jobTitle,industry:o[0]?.industry,companyLinkedinUrl:o[0]?.companyLinkedinUrl},currentJobs:o[0]});}return n}async parseLocation(t,e,n){let r,a,s=t?.split(", ");if(s?.length&&(r=this._cleanCityFromLinkedinDetails(s[0])),n&&n.toLocaleLowerCase()!=="oo")a=n.toLocaleUpperCase();else if(e)a=f(e)?.toLocaleUpperCase();else if(s&&s.length===1){let l=s[0];a=f(l),a&&(r=void 0);}else if(s&&s[2])a=f(s[2])?.toLocaleUpperCase();else if(s&&s[1]){let l=s[1];a=f(l)?.toLocaleUpperCase();}return a==="HK"&&!r&&(r="Hong Kong"),a==="SG"&&!r&&(r="Singapore"),{city:r,country:a}}};var R=class{constructor({client:t}){this._cleanCityFromLinkedinDetails=t=>{let e=t,n=/ ((Metropolitan Area)|(Metropolitan Region)|(Metroplex)|(Bay Area)|(Area)|(Metro)|(Region))$/;return /^([\w ]+-){2}/i.test(e)&&n.test(e)&&(e=e.replace(/^([\w ]+-){2}/i,"")),/^[\w ]+?-/i.test(e)&&n.test(e)&&(e=e.replace(/^[\w ]+?-/i,"")),/--/i.test(e)&&n.test(e)&&(e=e.split("--").pop()||e),e=e.replace(/Greater /i,""),e=e.replace(n,""),e=e.replace(/st\. /gi,"Saint ").replace(/ st\./gi," Saint"),e};this.client=t;}async getProfile({profileHash:t}){let e=await this.client.request.salesnav.getProfile({profileHash:t}),n=e?.objectUrn.split(":").pop(),r=t,{country:a,city:s}=await this.parseLocation(e?.location),l=e?.positions||[],o=l.filter(c=>l.length<=1?true:!c?.endedOn).map(c=>{let A={};return c&&(A.jobTitle=c.title||void 0,A.companyName=c.companyName||void 0,c.companyUrnResolutionResult&&(A.industry=c.companyUrnResolutionResult.industry,A.companySize=c.companyUrnResolutionResult.employeeCountRange,A.companyLinkedinUniversalName=c.companyUrn?.split(":").pop())),A});return {lead:{firstName:e?.firstName||"",lastName:e?.lastName||"",linkedinId:n,profileHash:r,country:a,city:s,jobTitle:o[0]?.jobTitle,companyName:o[0]?.companyName,industry:o[0]?.industry,companySize:o[0]?.companySize,companyLinkedinUrl:this._getLinkedinCompanyUrlFromUniversalName(o[0]?.companyLinkedinUniversalName)},currentJobs:o[0]}}async parseLocation(t,e,n){let r,a,s=t?.split(", ");if(s?.length&&(r=this._cleanCityFromLinkedinDetails(s[0])),n&&n.toLocaleLowerCase()!=="oo")a=n.toLocaleUpperCase();else if(e)a=f(e)?.toLocaleUpperCase();else if(s&&s.length===1){let l=s[0];a=f(l),a&&(r=void 0);}else if(s&&s[2])a=f(s[2])?.toLocaleUpperCase();else if(s&&s[1]){let l=s[1];a=f(l)?.toLocaleUpperCase();}return a==="HK"&&!r&&(r="Hong Kong"),a==="SG"&&!r&&(r="Singapore"),{city:r,country:a}}_getLinkedinCompanyUrlFromUniversalName(t){if(t)return `https://linkedin.com/company/${t}`}};var W="com.linkedin.voyager.relationships.invitation.Invitation";var b=class{constructor({createdBefore:t}){this.pageIndexes=[];this.createdBefore=t?.getTime();}async scrollNext(){let t=await this.fetch();return this.prevCreatedBefore&&this.pageIndexes.push(this.prevCreatedBefore),z__default.default(t)||(this.prevCreatedBefore=this.createdBefore||t[0][this.fieldName]+1e3,this.createdBefore=t[t.length-1][this.fieldName]),t}async scrollBack(){return z__default.default(this.pageIndexes)?[]:(this.createdBefore=this.pageIndexes.pop(),this.fetch())}restart(){this.createdBefore=void 0,this.pageIndexes=[];}};var S=class{constructor({skip:t,limit:e}){this.scrollNextCounter=0;this.hitEndOfResults=false;this.skip=t,this.limit=e;}async scrollNext(){if(this.hitEndOfResults)return [];let t=await this.fetch();return z__default.default(t)&&(this.hitEndOfResults=true),this.skip+=this.limit,this.scrollNextCounter+=1,t}async scrollBack(){return this.hitEndOfResults=false,this.scrollNextCounter===1?(this.skip=0,this.scrollNextCounter=0,[]):(this.skip=Math.max(this.skip-this.limit*2,0),this.skip===0&&(this.scrollNextCounter=0),this.fetch())}restart(){this.skip=0,this.limit=10;}};var C=class extends S{constructor({fetchInvitations:t,skip:e=0,limit:n=100}){super({skip:e,limit:n}),this.fetchInvitations=t;}async fetch(){return this.fetchInvitations({skip:this.skip,limit:this.limit})}};var L=class extends b{constructor({fetchMessages:e,conversationId:n,createdBefore:r}){super({createdBefore:r});this.fieldName="createdAt";this.fetchMessages=e,this.conversationId=n;}async fetch(){return this.fetchMessages({conversationId:this.conversationId,...ye__default.default(this.createdBefore)?{}:{createdBefore:new Date(this.createdBefore)}})}};var fe="*toMember",Ae="*fromMember",Y=i=>t=>{let e=t.included||[],n=ge__default.default(()=>{}),r=e.filter(a=>a.$type===W&&!!a[i]);return Pe__default.default(r.map(a=>({...a,profile:n[a[i]]})),"sentTime","desc")},Te=Y(fe),xe=Y(Ae),M=class{constructor({client:t}){this.client=t;}getSentInvitations({skip:t=0,limit:e=100}={}){return new C({skip:t,limit:e,fetchInvitations:this.fetchSent.bind(this)})}getReceivedInvitations({skip:t=0,limit:e=100}={}){return new C({skip:t,limit:e,fetchInvitations:this.fetchReceived.bind(this)})}async sendInvitation({profileId:t,message:e}){return await this.client.request.invitation.sendInvitation({profileId:t,message:e}),(await this.fetchSent({skip:0,limit:1}))[0]}async fetchReceived({skip:t=0,limit:e=100}={}){let n=await this.client.invitation.getReceivedInvitations({skip:t,limit:e});return xe(n)}async fetchSent({skip:t=0,limit:e=100}={}){let n=await this.client.invitation.getSentInvitations({skip:t,limit:e});return Te(n)}};var Z="com.linkedin.voyager.messaging.Event";var he=i=>i.replace(/urn:li:fs_messagingMember:\(|\)/g,"").split(",")[1],v=class{constructor({client:t}){this.client=t;}getMessages({conversationId:t,createdBefore:e}){return new L({conversationId:t,createdBefore:e,fetchMessages:this.fetchMessages.bind(this)})}async sendMessage({profileIds:t,conversationId:e,text:n}){return {...(await this.client.request.message.sendMessage({profileIds:t,conversationId:e,text:n}))?.data?.value,text:n}}async fetchMessages({conversationId:t,createdBefore:e}){let n=await this.client.request.message.getMessages({conversationId:t,createdBefore:e}),r=n.included.filter(s=>s.$type===Z),a=getProfilesFromResponse(n);return Pe__default.default(r,"createdAt","desc").map(s=>({...s,text:s?.eventContent?.attributedBody?.text,sentFrom:a[he(s["*from"])]}))}};var O=class extends y{constructor(t){super(t);}sendInvitation({profileId:t,message:e}){let n={action:"verifyQuotaAndCreateV2",decorationId:"com.linkedin.voyager.dash.deco.relationships.InvitationCreationResultWithInvitee-2"},r={invitee:{inviteeUnion:{memberProfile:"urn:li:fsd_profile:"+t}},...e&&{customMessage:e}};return this.fetchJson("voyagerRelationshipsDashMemberRelationships",{method:"POST",body:JSON.stringify(r),queryParams:n})}getReceivedInvitations({skip:t=0,limit:e=100}={}){let n={start:t,count:e,q:"receivedInvitation"};return this.fetchJson("relationships/invitationViews",{queryParams:n})}getSentInvitations({skip:t=0,limit:e=100}={}){let n={start:t,count:e,invitationType:"CONNECTION",q:"invitationType"};return this.fetchJson("relationships/sentInvitationViewsV2",{queryParams:n})}};var $=class extends y{constructor(t){super(t);}async sendMessage({profileIds:t,text:e,conversationId:n}){let r={action:"create"},a={keyVersion:"LEGACY_INBOX",conversationCreate:{eventCreate:{value:{"com.linkedin.voyager.messaging.create.MessageCreate":{attributedBody:{text:e,attributes:[]},attachments:[]}}},subtype:"MEMBER_TO_MEMBER",recipients:t}},s={eventCreate:{originToken:"54b3a724-59c5-4cf2-adbd-660483010a87",value:{"com.linkedin.voyager.messaging.create.MessageCreate":{attributedBody:{text:e,attributes:[]},attachments:[]}}},dedupeByClientGeneratedToken:false},l=`messaging/conversations/${n}/events`,o="messaging/conversations",m=n?s:a,c=n?l:o;return this.fetchJson(c,{method:"POST",body:JSON.stringify(m),queryParams:r})}async getMessages({conversationId:t,createdBefore:e}){let n={keyVersion:"LEGACY_INBOX",...e&&{createdBefore:e.getTime()}};return this.fetchJson(`messaging/conversations/${t}/events`,{queryParams:n})}};var F=class extends y{constructor(t){super(t);}async getOwnProfile(){return this.fetchJson("me")}getProfile({profileHash:t}){let e={q:"memberIdentity",memberIdentity:t,decorationId:"com.linkedin.voyager.dash.deco.identity.profile.FullProfileWithEntities-35"};return this.fetchJson("identity/dash/profiles",{queryParams:e})}};var N=class extends y{constructor(e){super(e);this.getProfile=async({profileHash:e})=>{let n={decoration:this._craftProfileUrlDecoration()};return this.fetchJson(`salesApiProfiles/(profileId:${e})`,{queryParams:n,overwriteHeaders:this.overwriteHeaders})};}_craftProfileUrlDecoration(e=false){let n="(entityUrn,objectUrn,firstName,lastName,location,flagshipProfileUrl,positions*(companyName,current,new,description,endedOn,startedOn,title,location,companyUrn~fs_salesCompany(entityUrn,name,employeeCountRange,industry)))";return e!==true&&(n=encodeURIComponent(n).replace(/\(/g,"%28").replace(/\)/g,"%29")),n}overwriteHeaders(e){delete e["content-encoding"],e.accept="*/*";}};var w=class{constructor(t){this._opts=t;}get profile(){let t="https://www.linkedin.com/voyager/api/";return new F({...this._opts,baseURL:t})}get salesnav(){let t="https://www.linkedin.com/sales-api/";return new N({...this._opts,baseURL:t})}get salesnavSearch(){let t="https://www.linkedin.com/";return new U({...this._opts,baseURL:t})}get message(){let t="https://www.linkedin.com/voyager/api/";return new $({...this._opts,baseURL:t})}get invitation(){let t="https://www.linkedin.com/voyager/api/";return new O({...this._opts,baseURL:t})}};var _=class{constructor(t){this.profile=new E({client:this});this.salesnav=new R({client:this});this.salesnavSearch=new I({client:this});this.message=new v({client:this});this.invitation=new M({client:this});this.request=new w(t);}};var Ce=async(i,t)=>{let e=i.queue;console.log("queueId",e.id);try{let n=e.input,r=n.linkedinPayload.url,s=await new _({cookies:n.linkedinPayload.cookies,linkedinHeaders:n.linkedinPayload.headers}).salesnavSearch.scrapeSearchResult(r,async o=>{let m=o.scrapedLeads.map(d=>d.currentJobs).reduce((d,P)=>{if(!P)return d;let B=P?.companyWebsite?D(P.companyWebsite):void 0;return B&&(P.companyWebsite=B,d.set(B,P)),d},new Map);await p.company.createMany({data:Array.from(m.values()).map(d=>({domain:d.companyWebsite,name:d.companyName,size:d.companySize,industry:d.industry,linkedinUrl:d.companyLinkedinUrl})),skipDuplicates:!0});let c=await p.company.findMany({where:{domain:{in:Array.from(m.keys())}},select:{id:!0,domain:!0}}),A=new Map(c.map(d=>[d.domain,d.id])),h=o.scrapedLeads.map(({lead:d,currentJobs:P})=>({firstName:d.firstName,lastName:d.lastName,listId:n.list.id,city:d.city,country:d.country,companyId:P?.companyWebsite?A.get(D(P.companyWebsite)):void 0,industry:d?.industry,linkedinHash:d.profileHash,jobTitle:d.jobTitle,linkedinId:d.linkedinId,isLinkedinPremium:d.isLinkedinPremium,source:"sales_nav"}));return await p.lead.createMany({data:h}),!0}),l=await p.lead.count({where:{listId:n.list.id}});await p.queueJob.update({where:{id:e.id},data:{status:"completed",isFailed:!s,lastMessage:s?"Completed successfully":"Something went wrong...",logs:{push:[`${s?"Completed":"Failed"} at ${T()}`,`${l} leads extracted`]}}}),t(null,!0);}catch(n){console.error(`[WORKER SALES_NAV_EXTRACTION] ${n.message}`),await p.queueJob.update({where:{id:e.id},data:{status:"completed",isFailed:true,lastMessage:n.message,logs:{push:`Failed at ${T()}`}}}),t(n,false);}},Ee=be__default.default(Ce,5),X=i=>{Ee.push({queue:i});};async function Ue(){let i=await p.queueJob.findMany({where:{type:"sales_nav_extraction",status:{in:["todo","processing"]}}});for(let t of i)await p.queueJob.update({where:{id:t.id},data:{status:"processing",logs:{push:`[Server RestDarted] Resume at ${T()}`}}}),X(t);}async function ee(){let i=await p.queueJob.findFirst({where:{status:"todo",type:"sales_nav_extraction"}});i&&(await p.queueJob.update({where:{id:i.id},data:{status:"processing",logs:{push:`Started at ${T()}`}}}),X(i)),setTimeout(ee,1e4);}function te(){Ue(),ee();}var ke=async()=>{console.log(`[worker] Started at ${T()}`),te();};ke();
